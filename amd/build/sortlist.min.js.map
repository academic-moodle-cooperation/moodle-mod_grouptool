{"version":3,"file":"sortlist.min.js","sources":["../src/sortlist.js"],"sourcesContent":["// This file is part of mod_grouptool for Moodle - http://moodle.org/\n//\n// It is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// It is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript for sortable groups-list\n *\n * @module   mod_grouptool/sortlist\n * @author    Philipp Hager\n * @copyright 2014 Academic Moodle Cooperation {@link http://www.academic-moodle-cooperation.org}\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n /**\n  * @module mod_grouptool/sortlist\n  */\ndefine(['jquery', 'jqueryui', 'core/ajax', 'core/templates', 'core/str', 'core/log', 'core/notification'], function($, jqui, ajax,\n        templates, str, log, notif) {\n\n    /**\n     * @constructor\n     * @alias module:mod_grouptool/sortlist\n     */\n    var Sortlist = function() {\n        this.cmid = 0;\n    };\n\n    /**\n     * Change the checked checkboxes due to action in checkbox-controller!\n     *\n     * @param {Event} e Event object\n     * @param {string} newstate select|deselect|toggle\n     */\n    Sortlist.prototype.updateCheckboxes = function(e, newstate) {\n\n        var selector = '';\n\n        // Get all selected groupids and construct selector!\n        $('select[name=\"classes[]\"] option:selected').each(function(idx, current) {\n            if (selector !== '') {\n                selector += ', ';\n            }\n            selector += '.class' + $(current).val();\n        });\n        var checkboxes = $(selector);\n\n        e.preventDefault();\n\n        switch (newstate) {\n            case 'select': // Check!\n                checkboxes.prop('checked', true);\n                break;\n            case 'deselect': // Uncheck!\n                checkboxes.prop('checked', false);\n                break;\n            case 'toggle':\n                checkboxes.each(function(idx, current) {\n                    if ($(current).prop('checked')) {\n                        $(current).prop('checked', false);\n                    } else {\n                        $(current).prop('checked', true);\n                    }\n                });\n                break;\n            default:\n                log.info('Undefined new checkbox state!', 'grouptool');\n                break;\n        }\n    };\n\n    /**\n     * Start of dragging!\n     *\n     * @param {Event} e Event object\n     * @param {object} ui Jquery UI instance\n     */\n    Sortlist.prototype.dragStartHandler = function(e, ui) {\n        // Get our drag object!\n        var helper = ui.helper;\n\n        helper.find('a[data-movedown], a[data-moveup]').css('visibility', 'visible');\n    };\n\n    /**\n     * End of drag!\n     *\n     * @param {Event} e Event object\n     */\n    Sortlist.prototype.dragEndHandler = function(e) {\n        // Set the hidden fields containing the sort order new!\n        var neworderparams = [];\n\n        var sortlistEntries = $('.mod_grouptool_sortlist_body .mod_grouptool_sortlist_entry');\n        sortlistEntries.find('a[data-movedown], a[data-moveup]').css('visibility', 'visible');\n        sortlistEntries.first().find('a[data-moveup]').css('visibility', 'hidden');\n        sortlistEntries.last().find('a[data-movedown]').css('visibility', 'hidden');\n\n        sortlistEntries.each(function(index) {\n            // Using attr here, to have updated values seen in the HTML too!\n            $(this).attr('order', index + 1);\n            $(this).find('input[name=\"order[' + $(this).data('id') + ']\"]').val(index + 1);\n\n            // Add new order to new order params!\n            neworderparams.push({\n                groupid: $(this).data('id'),\n                order: index + 1\n            });\n        });\n\n        if (neworderparams !== '') {\n            var requests = ajax.call([{\n                methodname: 'mod_grouptool_reorder_groups',\n                args: {cmid: e.data.cmid, order: neworderparams},\n                fail: notif.exception\n            }]);\n            requests[0].then(function(result) {\n                var context = {\n                    'message': '',\n                    'extraclasses': 'infonode'\n                };\n                var template = 'core/notification_success';\n                var autoFadeOut = 5 * 1000;\n\n                if (result.error) {\n                    template = 'core/notification_error';\n                    context.message = result.error;\n                    autoFadeOut = 60 * 1000;\n                    log.info(\"AJAX Call to reorder groups successfull\\nError ocured:\" + result.error + \"\\n\" + status, \"grouptool\");\n                    templates.render(template, context).then(function(html) {\n                        var infoNode = $(html);\n                        infoNode.hide(0);\n                        $('table.drag_list').before(infoNode);\n                        infoNode.slideDown(600, function() {\n                            window.setTimeout(function() {\n                                infoNode.slideUp(600, function() {\n                                    infoNode.remove();\n                                });\n                            }, autoFadeOut);\n                        });\n\n                        return this;\n                    }).fail(notif.exception);\n                } else {\n                    context.message = result.message;\n                    log.info(\"AJAX Call to reorder groups successfull\\n\" + result.message + \"\\n\" + status, \"grouptool\");\n                }\n\n\n                return this;\n            }).fail(notif.exception);\n        }\n    };\n\n    /**\n     * Move the element 1 position down!\n     *\n     * @param {Event} e Event object\n     */\n    Sortlist.prototype.moveDown = function(e) {\n        // Swap sort-order-values!\n        var target = $(e.target);\n        var nodeA = target.closest('.mod_grouptool_sortlist_entry');\n        var nodeB = target.closest('.mod_grouptool_sortlist_entry').next('.mod_grouptool_sortlist_entry');\n        var thisOrder = nodeA.data('order');\n        var otherOrder = nodeB.data('order');\n\n        // Stop the button from submitting!\n        e.preventDefault();\n        e.stopPropagation();\n\n        var requests = ajax.call([{\n            methodname: 'mod_grouptool_swap_groups',\n            args: {cmid: e.data.cmid, a: nodeA.data('id'), b: nodeB.data('id')},\n            fail: notif.exception\n        }]);\n        requests[0].then(function(result) {\n            if (result.error) {\n                notif.exception(result.error);\n            } else {\n                // Swap list-elements!\n                nodeB.after(nodeA.clone(true));\n                nodeA.replaceWith(nodeB);\n\n                nodeA.data('order', otherOrder);\n                nodeA.find('input[name=\"order[' + nodeA.data('id') + ']\"]').val(otherOrder);\n                nodeB.data('order', thisOrder);\n                nodeB.find('input[name=\"order[' + nodeB.data('id') + ']\"]').val(thisOrder);\n                log.info(result.message);\n            }\n\n            return this;\n        }).fail(notif.exception);\n    };\n\n    /**\n     * Move the element 1 position up!\n     *\n     * @param {Event} e Event object\n     */\n    Sortlist.prototype.moveUp = function(e) {\n        // Swap sort-order-values!\n        var target = $(e.target);\n        var nodeA = target.closest('.mod_grouptool_sortlist_entry');\n        var nodeB = target.closest('.mod_grouptool_sortlist_entry').prev('.mod_grouptool_sortlist_entry');\n\n        var thisOrder = nodeA.data('order');\n        var otherOrder = nodeB.data('order');\n\n        // Stop the button from submitting!\n        e.preventDefault();\n        e.stopPropagation();\n\n        var requests = ajax.call([{\n            methodname: 'mod_grouptool_swap_groups',\n            args: {cmid: e.data.cmid, a: nodeA.data('id'), b: nodeB.data('id')},\n            fail: notif.exception\n        }]);\n        requests[0].then(function(result) {\n            if (result.error) {\n                notif.exception(result.error);\n            } else {\n                // Swap list-elements!\n                nodeB.before(nodeA.clone(true));\n                nodeA.replaceWith(nodeB);\n\n                nodeA.data('order', otherOrder);\n                nodeA.find('input[name=\"order[' + nodeA.data('id') + ']\"]').val(otherOrder);\n                nodeB.data('order', thisOrder);\n                nodeB.find('input[name=\"order[' + nodeB.data('id') + ']\"]').val(thisOrder);\n                log.info(result.message);\n            }\n\n            return this;\n        }).fail(notif.exception);\n    };\n\n    var instance = new Sortlist();\n\n    /**\n     * Initializer\n     *\n     * @param {int} cmid\n     */\n    instance.initializer = function(cmid) {\n\n        instance.cmid = cmid;\n\n        log.info('Initialize Grouptool sortlist', 'grouptool');\n        $('.path-mod-grouptool .mod_grouptool_sortlist .mod_grouptool_sortlist_body').sortable({\n            containment: '.mod_grouptool_sortlist .mod_grouptool_sortlist_body',\n            cursor: 'move',\n            delay: 150,\n            handle: '[data-drag]',\n            items: ' .mod_grouptool_sortlist_entry',\n            opacity: 0.5,\n            helper: 'clone',\n            axis: 'y',\n            start: instance.dragStartHandler,\n            stop: function(e) {\n                e.data = instance;\n                instance.dragEndHandler(e);\n            }\n        });\n        // Enable the drag-symbols when JS is enabled :)!\n        var dragnodes = $('.path-mod-grouptool .mod_grouptool_sortlist tr[data-id] [data-drag]');\n        $('.path-mod-grouptool .mod_grouptool_sortlist tr .js_invisible').removeClass('js_invisible');\n        dragnodes.removeClass('js_invisible');\n        dragnodes.css('cursor', 'pointer');\n\n        // Add JS-Eventhandler for each move-up/down-button-click (=images)!\n        var sortlistnode = $('.path-mod-grouptool .mod_grouptool_sortlist');\n        sortlistnode.on('click', 'tr[data-id] a[data-movedown]', this, instance.moveDown);\n        sortlistnode.on('click', 'tr[data-id] a[data-moveup]', this, instance.moveUp);\n\n        // Enhanced checkbox-controller functionality!\n        var checkboxControlsAction = $('button[name=\"do_class_action\"]');\n        if (checkboxControlsAction) {\n            require(['mod_grouptool/multiseltoggle'], function(toggle) {\n                var select = $('select[name=\"classes[]\"]');\n                toggle.enable(select.get()[0]);\n            });\n            checkboxControlsAction.on('click', function(e) {\n                // Get the new state and continue!\n                var newstate = '';\n                $('input[name=\"class_action\"]').each(function(idx, current) {\n                    if ($(current).prop('checked') === true) {\n                        newstate = $(current).val();\n                        log.info('Update checkboxes \\'' + newstate + '\\'!');\n                        instance.updateCheckboxes(e, newstate);\n                    }\n                });\n\n            });\n        } else {\n            log.info('No sortlist controller found!', 'grouptool');\n        }\n\n        // Action button to select all!\n        $('.simple_select_all').on('click', function(e) {\n            log.info('Bind select-all handler!', 'grouptool');\n            e.preventDefault();\n            e.stopPropagation();\n\n            $('.class0').prop('checked', true);\n        });\n\n        // Action button to select none!\n        $('.simple_select_none').on('click', function(e) {\n            log.info('Bind deselect-all handler!', 'grouptool');\n            e.preventDefault();\n            e.stopPropagation();\n\n            $('.class0').prop('checked', false);\n        });\n    };\n\n    return instance;\n});\n"],"names":["define","$","jqui","ajax","templates","str","log","notif","Sortlist","cmid","prototype","updateCheckboxes","e","newstate","selector","each","idx","current","val","checkboxes","preventDefault","prop","info","dragStartHandler","ui","helper","find","css","dragEndHandler","neworderparams","sortlistEntries","first","last","index","this","attr","data","push","groupid","order","call","methodname","args","fail","exception","then","result","context","template","autoFadeOut","error","message","status","render","html","infoNode","hide","before","slideDown","window","setTimeout","slideUp","remove","moveDown","target","nodeA","closest","nodeB","next","thisOrder","otherOrder","stopPropagation","a","b","after","clone","replaceWith","moveUp","prev","instance","initializer","sortable","containment","cursor","delay","handle","items","opacity","axis","start","stop","dragnodes","removeClass","sortlistnode","on","checkboxControlsAction","require","toggle","select","enable","get"],"mappings":"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"}