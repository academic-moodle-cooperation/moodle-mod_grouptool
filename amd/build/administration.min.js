define(["jquery","core/config","core/str","core/url","core/notification","core/log"],function(a,b,c,d,e,f){var g=function(){this.contextid=0,this.lang="en",this.filter=null,this.filterid=null,this.globalsize=3};g.prototype.renamegroup=function(c){f.info("Rename Group!","grouptool"),c.preventDefault(),c.stopPropagation(),c.target=a(c.target);var d=c.target.attr("name").replace(/[^\d]/g,""),e=c.target.closest("a"),g=e.prevAll("input[type=hidden]"),h=e.prevAll("span.text"),i="";e.fadeOut(600),g.fadeOut(600),h.fadeOut(600,function(){g.attr("type","text"),g.fadeIn(600),g.focus(),g.select()}),g.on("keydown",function(c){if((13===c.which||27===c.which)&&(c.preventDefault(),c.stopPropagation()),13===c.which){var j={method:"POST",url:b.wwwroot+"/mod/grouptool/editgroup_ajax.php",data:{action:"rename",groupid:d,name:g.val(),sesskey:b.sesskey,contextid:c.data.contextid},headers:{"X-Transaction":"POST rename group "+d},dataType:"json",beforeSend:function(){i&&i.fadeOut(600).delay(600).remove(),f.info("Start AJAX Call to rename group "+d,"grouptool")},complete:function(){f.info("AJAX Call to rename group "+d+" completed","grouptool")},success:function(b,c){b.error?(h.before('<div class="infonode alert-error" style="display:none">'+b.error+"</div>"),i=a("div.infonode"),i.fadeIn(600),window.setTimeout(function(){i.fadeOut(600).delay(600).remove()},6e4)):(h.before('<div class="infonode alert-success" style="display:none">'+b.message+"</div>"),i=a("div.infonode"),i.fadeIn(600),h.html(g.val()),g.fadeOut(600,function(){g.attr("value",g.val()),g.attr("type","hidden"),h.fadeIn(600),e.fadeIn(600)}),g.off("keydown"),window.setTimeout(function(){i.fadeOut(600).delay(600).remove()},5e3)),f.info("AJAX Call to rename group "+d+" successfull\n"+c,"grouptool")},error:function(b,c,e){var g=a('<div class="infonode alert-error" style="display:none">'+c+'<br /><span class="small">'+e+"</span></div>");i=h.before(g),i.fadeIn(600),f.error("AJAX Call to rename group "+d+" failure","grouptool")},end:function(){f.info("AJAX Call to rename group "+d+" ended","grouptool")},statusCode:{404:function(){f.error("404: URL not found!","grouptool")},500:function(){f.error("500: Internal server error!","grouptool")}},timeout:6e4};a.ajax(j)}else 27===c.which&&(g.fadeOut(600,function(){h.hide(),g.attr("type","hidden"),g.val(h.html()),g.attr("value",h.html()),h.fadeIn(600),e.fadeIn(600)}),i&&i.fadeOut(600).delay(600).remove(),g.off("keydown"))})},g.prototype.resizegroup=function(c){f.info("Resize Group!","grouptool"),c.preventDefault(),c.stopPropagation(),c.target=a(c.target);var d=c.target.attr("name").replace(/[^\d]/g,""),e=c.data.strings,g=c.data.admin,h=c.target.closest("a"),i=h.prevAll("input[type=hidden]"),j=h.prevAll("span.text"),k="",l="";h.fadeOut(600),i.fadeOut(600),j.fadeOut(600,function(){i.attr("type","text"),i.fadeIn(600),i.focus(),i.select();var b=a('<div class="helpnode alert-info" style="display:none">'+e.resizehelp+"</div>");j.before(b),l=a("div.helpnode"),l.fadeIn(600)}),i.on("keydown",function(c){if((13===c.which||27===c.which)&&(c.preventDefault(),c.stopPropagation()),13===c.which){var e={method:"POST",url:b.wwwroot+"/mod/grouptool/editgroup_ajax.php",data:{action:"resize",groupid:d,size:i.val(),sesskey:b.sesskey,contextid:g.contextid},headers:{"X-Transaction":"POST resize group "+d},dataType:"json",beforeSend:function(){k&&(k.fadeOut(600),k.remove()),l&&(l.fadeOut(600),l.remove()),f.info("Start AJAX Call to resize group "+d,"grouptool")},complete:function(){f.info("AJAX Call to resize group "+d+" completed","grouptool")},success:function(b,c){var e="";if(b.error)e=a('<div class="infonode alert-error" style="display:none">'+b.error+"</div>"),j.before(e),k=a("div.infonode"),k.fadeIn(600),window.setTimeout(k.fadeOut(600).delay(600).remove(),6e4);else{e=a('<div class="infonode alert-success" style="display:none">'+b.message+"</div>"),j.before(e),k=a("div.infonode"),k.fadeIn(600);var l=i.val();""===l?j.html(g.globalsize+"*"):j.html(l),i.fadeOut(600,function(){i.attr("value",i.val()),i.attr("type","hidden"),j.fadeIn(600),h.fadeIn(600),i.off("keydown")}),window.setTimeout(function(){k.fadeOut(600).delay(600).remove()},5e3)}f.info("AJAX Call to resize group "+d+" successfull\n"+c,"grouptool")},error:function(b,c,e){b=null;var g=a('<div class="infonode alert-error" style="display:none">'+c+"</div>");k=j.before(g),k.fadeIn(600),f.error("AJAX Call to resize group "+d+" failure\n"+e,"grouptool")},end:function(){f.info("AJAX Call to resize group "+d+" ended","grouptool")},statusCode:{404:function(){f.error("404: URL not found!","grouptool")},500:function(){f.error("500: Internal server error!","grouptool")}},timeout:6e4};a.ajax(e)}else 27===c.which&&(c.preventDefault(),c.stopPropagation(),i.fadeOut(600,function(){j.hide(),i.attr("type","hidden"),i.attr("value",j.html()),i.val(j.html()),j.fadeIn(600),h.fadeIn(600)}),k&&k.fadeOut(600).delay(600).remove(),l&&l.fadeOut(600).delay(600).remove(),i.unbind("key"))})},g.prototype.togglegroup=function(e){e.preventDefault(),e.stopPropagation(),e.target=a(e.target);var g=e.target.attr("name").replace(/[^\d]/g,"");f.info("TOGGLE GROUP "+g,"grouptool");var h;e.target.hasClass("active")?(f.info("DEACTIVATE GROUP "+g+"!","grouptool"),h={method:"POST",url:b.wwwroot+"/mod/grouptool/editgroup_ajax.php",data:{action:"deactivate",groupid:g,sesskey:b.sesskey,contextid:e.data.contextid,filter:e.data.filterid},headers:{"X-Transaction":"POST rename group "+g},dataType:"json",beforeSend:function(){f.info("Start AJAX Call to deactivate group "+g+"\n"+h.url+"?action=deactivate&groupid="+g+"&sesskey="+b.sesskey+"&contextid="+e.data.contextid,"grouptool")},complete:function(){f.info("AJAX Call to deactivate group "+g+" completed","grouptool")},success:function(b,h){var i=c.get_string("inactive","mod_grouptool");b.error?f.info("AJAX Call to deactivate group "+g+" successfull but error occured:\n"+b.error+"\n"+h,"grouptool"):("active"===e.data.filter?e.target.closest("tr").fadeOut(600,function(){e.target.closest("tr").remove(),""!==b.noentriesmessage&&a("div.sortlist_container").fadeOut(600,function(){a("div.sortlist_container").html(b.noentriesmessage),a("div.sortlist_container").fadeIn(600)})}):e.target.closest("tr").fadeOut("fadeOut",function(){e.target.closest("tr").addClass("dimmed_text"),a(e.target).removeClass("active").addClass("inactive"),e.target.attr("src",d.imageUrl("inactive","mod_grouptool")),i.done(function(a){e.target.attr("alt",a)}).fail(function(a){f.error("Error retrieving string: "+a,"grouptool")}),e.target.closest("tr").fadeIn(600)}),f.info("AJAX Call to deactivate group "+g+" successfull\n"+b.message+"\n"+h,"grouptool"))},error:function(){f.error("AJAX Call to deactivate group "+g+" failure","grouptool")},end:function(){f.info("AJAX Call to deactivate group "+g+" ended","grouptool")},timeout:6e4},a.ajax(h)):e.target.hasClass("inactive")?(f.info("ACTIVATE GROUP "+g+"!","grouptool"),h={method:"POST",url:b.wwwroot+"/mod/grouptool/editgroup_ajax.php",data:{action:"activate",groupid:g,sesskey:b.sesskey,contextid:e.data.contextid,filter:e.data.filterid},headers:{"X-Transaction":"POST rename group "+g},beforeSend:function(){f.info("Start AJAX Call to activate group "+g+"\n"+h.url+"?action=deactivate&groupid="+g+"&sesskey="+b.sesskey+"&contextid="+e.data.contextid,"grouptool")},complete:function(){f.info("AJAX Call to activate group "+g+" completed","grouptool")},success:function(b,h){var i=c.get_string("active","mod_grouptool");b.error?f.info("AJAX Call to activate group "+g+" successfull but error occured:\n"+b.error+"\n"+h,"grouptool"):("inactive"===e.data.filter?e.target.closest("tr").fadeOut(600,function(){e.target.closest("tr").remove(),""!==b.noentriesmessage&&a("div.sortlist_container").fadeOut(600,function(){a("div.sortlist_container").html(b.noentriesmessage),a("div.sortlist_container").fadeIn(600)})}):e.target.closest("tr").fadeOut(600,function(){e.target.closest("tr").removeClass("dimmed_text"),e.target.removeClass("inactive").addClass("active"),e.target.attr("src",d.imageUrl("active","mod_grouptool")),i.done(function(a){e.target.attr("alt",a)}).fail(function(a){f.error("Error while retrieving string: "+a,"grouptool")}),e.target.closest("tr").fadeIn(600)}),f.info("AJAX Call to activate group "+g+" successfull\n"+b.message,"grouptool"))},error:function(a,b,c){f.error("AJAX Call to activate group "+g+" failure\n"+b+"\n"+c,"grouptool")},end:function(){f.info("AJAX Call to activate group "+g+" ended","info","grouptool")},statusCode:{404:function(){f.error("404: URL not found!","grouptool")},500:function(){f.error("500: Internal server error!","grouptool")}},timeout:6e4},a.ajax(h)):f.error("Group with id "+g+' must have either class "active" or "inactive"!',"grouptool")},g.prototype.deletegroup=function(c){c.preventDefault(),c.stopPropagation(),c.target=a(c.target);var d=c.target.attr("name").replace(/[^\d]/g,""),g=c.data.admin,h=c.data.strings;e.confirm(h.title,h.confirm,h.yes,h.no,function(){if(!d)return void f.info("No Group ID!","grouptool");f.info("DELTE GROUP "+d+"!","grouptool");var c={method:"POST",url:b.wwwroot+"/mod/grouptool/editgroup_ajax.php",data:{action:"delete",groupid:d,sesskey:b.sesskey,contextid:g.contextid},headers:{"X-Transaction":"POST rename group "+d},beforeSend:function(){f.info("Start AJAX Call to delete group "+d,"grouptool")},complete:function(){f.info("AJAX Call to delete group "+d+" completed","grouptool")},success:function(b,c){b.error||a("#delete_"+d).closest("tr").fadeOut(600).delay(600).remove(),f.info("AJAX Call to delete group "+d+" successfull\n"+c,"grouptool")},error:function(){f.error("AJAX Call to rename group "+d+" failure","grouptool")},end:function(){f.info("AJAX Call to rename group "+d+" ended","grouptool")},statusCode:{404:function(){f.error("404: URL not found!","grouptool")},500:function(){f.error("500: Internal server error!","grouptool")}},timeout:6e4};a.ajax(c)})};var h=new g;return h.initializer=function(b){this.contextid=b.contextid,this.lang=b.lang,this.filter=b.filter,this.filterid=b.filterid,this.globalsize=b.globalsize,f.info("Initalize Grouptool group administration","grouptool"),a(".path-mod-grouptool a.renamebutton").on("click",null,this,this.renamegroup),f.debug("Init edit size button","grouptool"),c.get_strings([{key:"ajax_edit_size_help",component:"mod_grouptool"}]).done(function(b){var c={resizehelp:b[0]};f.debug("String successfully retrieved: "+b,"grouptool"),a(".path-mod-grouptool a.resizebutton").on("click",null,{strings:c,admin:h},h.resizegroup)}).fail(function(a){f.error("Error while retrieving string: "+a,"grouptool")}),c.get_strings([{key:"confirm_delete_title",component:"mod_grouptool"},{key:"confirm_delete",component:"mod_grouptool"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(b){f.info("Strings successfully retrieved: "+b,"grouptool");var c={title:b[0],confirm:b[1],yes:b[2],no:b[3]};a(".path-mod-grouptool a.deletebutton").on("click",null,{strings:c,admin:h},h.deletegroup)}).fail(function(a){f.error("Error while retrieving strings: "+a,"grouptool")}),a(".path-mod-grouptool a.togglebutton").on("click",null,this,this.togglegroup)},h});