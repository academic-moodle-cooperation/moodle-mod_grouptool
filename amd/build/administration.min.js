define(["jquery","core/templates","core/ajax","core/str","core/url","core/notification","core/log"],function(a,b,c,d,e,f,g){var h=function(){this.cmid=0,this.filter=null,this.filterall=null,this.globalsize=3};h.prototype.renamegroup=function(d){g.info("Rename Group!","grouptool"),d.preventDefault(),d.stopPropagation();var e={},h=[],i=a(d.target).closest("[data-rename]"),j=i.closest("tr"),k=j.data("id"),l=i,m=l.prevAll("input[type=hidden]"),n=l.prevAll("span.text"),o="";l.fadeOut(600),m.fadeOut(600),n.fadeOut(600,function(){m.attr("type","text"),m.fadeIn(600),m.focus(),m.select()}),m.on("keydown",null,d.data,function(d){13!==d.which&&27!==d.which||(d.preventDefault(),d.stopPropagation()),13===d.which?(h=c.call([{methodname:"mod_grouptool_rename_group",args:{cmid:d.data.cmid,groupid:k,name:m.val()},fail:f.exception}]),o&&(o.fadeOut(600),o.remove()),h[0].then(function(c){return c.error?(e={message:c.error},b.render("core/notification_error",e).then(function(b){return o=a(b),o.hide(),j.find(".grpname div").prepend(o),o.fadeIn(600),window.setTimeout(function(){o.fadeOut(600,function(){o.remove()})},6e4),this}).fail(f.exception)):(e={message:c.message},b.render("core/notification_success",e).then(function(b){return o=a(b),o.hide(),j.find(".grpname div").prepend(o),o.fadeIn(600),n.html(m.val()),m.fadeOut(600,function(){m.attr("value",m.val()),m.attr("type","hidden"),n.fadeIn(600),l.fadeIn(600)}),m.off("keydown"),window.setTimeout(function(){o.fadeOut(600,function(){o.remove()})},5e3),this}).fail(f.exception),g.info("AJAX Call to rename group "+k+" successfull\n"+status,"grouptool")),this}).fail(f.exception)):27===d.which&&(m.fadeOut(600,function(){n.hide(),m.attr("type","hidden"),m.val(n.html()),m.attr("value",n.html()),n.fadeIn(600),l.fadeIn(600)}),o&&o.fadeOut(600,function(){o.remove()}),m.unbind("key"))})},h.prototype.resizegroup=function(d){g.info("Resize Group!","grouptool"),d.preventDefault(),d.stopPropagation();var e=a(d.target).closest("[data-resize]"),h=e.closest("tr"),i=h.data("id"),j=d.data.instance.cmid,k=d.data.strings,l=d.data.globalsize,m=e,n=m.prevAll("input[type=hidden]"),o=m.prevAll("span.text"),p="",q="",r={},s=[];m.fadeOut(600),n.fadeOut(600),o.fadeOut(600,function(){n.attr("type","text"),n.fadeIn(600),n.focus(),n.select();var c={message:k.resizehelp};b.render("core/notification_info",c).then(function(b){return q=a(b),q.hide(),h.find(".size div").prepend(q),q.fadeIn(600),this}).fail(f.exception)}),n.on("keydown",null,null,function(d){13!==d.which&&27!==d.which||(d.preventDefault(),d.stopPropagation()),13===d.which?(s=c.call([{methodname:"mod_grouptool_resize_group",args:{cmid:parseInt(j),groupid:i,size:parseInt(n.val())},fail:f.exception}]),p&&(p.fadeOut(600),p.remove()),q&&(q.fadeOut(600),q.remove()),s[0].then(function(c){return c.error?(r={message:c.error},b.render("core/notification_error",r).then(function(b){return p=a(b),p.hide(),h.find(".size div").prepend(p),p.fadeIn(600),window.setTimeout(function(){p.fadeOut(600,function(){p.remove()})},6e4),this}).fail(f.exception)):(r={message:c.message},b.render("core/notification_success",r).then(function(b){p=a(b),p.hide(),h.find(".size div").prepend(p),p.fadeIn(600);var c=n.val();return""===c?o.html(l+"*"):o.html(c),n.fadeOut(600,function(){n.attr("value",n.val()),n.attr("type","hidden"),o.fadeIn(600),m.fadeIn(600),n.off("keydown")}),window.setTimeout(function(){p.fadeOut(600,function(){p.remove()})},5e3),this}).fail(f.exception)),g.info("AJAX Call to resize group "+i+" successfull\n"+status,"grouptool"),this}).fail(f.exception)):27===d.which&&(n.fadeOut(600,function(){o.hide(),n.attr("type","hidden"),n.attr("value",o.html()),n.val(o.html()),o.fadeIn(600),m.fadeIn(600)}),p&&p.fadeOut(600,function(){p.remove()}),q&&q.fadeOut(600,function(){p.remove()}),n.unbind("key"))})},h.prototype.togglegroup=function(h){h.preventDefault(),h.stopPropagation();var i=[],j={},k=a(h.target).closest("[data-toggle]"),l=k.closest("tr"),m=l.data("id");g.info("TOGGLE GROUP "+m,"grouptool");var n=l.data("status");1===n||n===!0?(g.info("DEACTIVATE GROUP "+m+"!","grouptool"),i=c.call([{methodname:"mod_grouptool_deactivate_group",args:{cmid:h.data.cmid,groupid:m},fail:f.exception}]),i[0].then(function(c){if(c.error){var i="AJAX Call to deactivate group "+m+" successfull but error occured:\n";g.info(i+c.error+"\n"+n,"grouptool")}else{if("active"===h.data.filter)l.find("td div").slideUp(600).promise().done(function(){if(l.remove(),!a("div.sortlist_container tr").length){var c=[{key:"nogroupsactive",component:"mod_grouptool"},{key:"nogroupschoose",component:"mod_grouptool"}];d.get_strings(c).done(function(c){var d=e.relativeUrl("/mod/grouptool/view.php",{id:h.data.cmid,tab:"group_administration",filter:h.data.filterall}),g='<a href="'+d+'">'+c[2]+"</a>",i={message:c[0]+g},j=a("div.sortlist_container");j.fadeOut(600,function(){b.render("core/notification_info",i).then(function(a){return j.html(a),j.fadeIn(600),this}).fail(f.exception)})}).fail(f.exception)}}).fail(f.exception);else{var o={id:h.data.cmid,tab:"administration"};j={status:!1,missing:!1,groupings:k.closest("tr").data("groupings"),id:m,checked:k.closest("tr").find("input[type=checkbox]").prop("checked"),name:k.closest("tr").data("name"),pageurl:e.relativeUrl("/mod/grouptool/view.php",o,!1),order:k.closest("tr").data("order"),usesize:!!h.data.usesize,size:k.closest("tr").data("size")};var p=b.render("mod_grouptool/sortlist_entry",j);l.toggleClass("slidup"),l.find("td div").slideUp(600).promise().done(function(){p.then(function(b){var c=l.parents("table").find("tr[data-status=0], tr[data-status=false]").first(),d=l.parents("table").find("tr[data-status=1], tr[data-status=true]").last();c.length?(l.detach(),l.insertBefore(c)):d.length&&(l.detach(),l.insertAfter(d));var e=a(b);return e.addClass("slidup"),e.find("td div").slideUp(0),l.replaceWith(e),e.find("[data-drag]").removeClass("js_invisible").css("cursor","pointer"),e.toggleClass("slidup"),e.find("td div").slideDown(600),l=e,this}).fail(f.exception)}).fail(f.exception)}g.info("AJAX Call to deactivate group "+m+" successfull\n"+c.message+"\n"+n,"grouptool")}return this}).fail(f.exception)):0===n||n===!1?(g.info("ACTIVATE GROUP "+m+"!","grouptool"),i=c.call([{methodname:"mod_grouptool_activate_group",args:{cmid:h.data.cmid,groupid:m},fail:f.exception}]),i[0].then(function(c){if(c.error){var i="AJAX Call to activate group "+m+" successfull but error occured:\n";g.info(i+c.error+"\n"+n,"grouptool")}else{if("inactive"===h.data.filter)l.find("td div").slideUp(600).promise().done(function(){if(l.remove(),!a("div.sortlist_container tr").length){var c=[{key:"nogroupsinactive",component:"mod_grouptool"},{key:"nogroupschoose",component:"mod_grouptool"}];d.get_strings(c).done(function(c){var d=e.relativeUrl("/mod/grouptool/view.php",{id:h.data.cmid,tab:"group_administration",filter:h.data.filterall}),g='<a href="'+d+'">'+c[2]+"</a>";j={message:c[0]+g};var i=a("div.sortlist_container");i.fadeOut(600,function(){b.render("core/notification_info",j).then(function(a){return i.html(a),i.fadeIn(600),this}).fail(f.exception)})}).fail(f.exception)}});else{var o={id:h.data.cmid,tab:"administration"};j={status:!0,missing:!1,groupings:l.data("groupings"),id:m,checked:l.find("input[type=checkbox]").prop("checked"),name:l.data("name"),pageurl:e.relativeUrl("/mod/grouptool/view.php",o,!1),order:l.data("order"),usesize:!!h.data.usesize,size:l.data("size")};var p=b.render("mod_grouptool/sortlist_entry",j);l.toggleClass("slidup"),k.closest("tr").find("td div").slideUp(600).promise().done(function(){p.then(function(b){var c=l.parents("table").find("tr[data-status=0], tr[data-status=false]").first(),d=l.parents("table").find("tr[data-status=1], tr[data-status=true]").last();d.length?(l.detach(),l.insertAfter(d)):c.length&&(l.detach(),l.insertBefore(c));var e=a(b);return e.addClass("slidup"),e.find("td div").slideUp(0),l.replaceWith(e),e.find("[data-drag]").removeClass("js_invisible").css("cursor","pointer"),e.toggleClass("slidup"),e.find("td div").slideDown(600),l=e,this}).fail(f.exception)}).fail(f.exception)}g.info("AJAX Call to activate group "+m+" successfull\n"+c.message,"grouptool")}return this}).fail(f.exception)):g.error("Group with id "+m+" must have either status 1 or 0!","grouptool")},h.prototype.deletegroup=function(b){if(b.preventDefault(),b.stopPropagation(),!a(b.target).closest("[data-delete]").hasClass("disabled")){var d=a(b.target).closest("[data-delete]"),e=d.closest("tr"),h=e.data("id"),i=b.data.strings;f.confirm(i.title,i.confirm,i.yes,i.no,function(){if(!h)return void g.info("No Group ID!","grouptool");g.info("DELETE GROUP "+h+"!","grouptool");var a=c.call([{methodname:"mod_grouptool_delete_group",args:{cmid:b.data.cmid,groupid:h},fail:f.exception}]);a[0].then(function(a){return f.fetchNotifications(),a.error?f.exception(a.error):e.find("td div").slideUp(600).promise().done(function(){e.remove()}),g.info("AJAX Call to delete group "+h+" successfull\n"+status,"grouptool"),this}).fail(f.exception)})}};var i=new h;return i.initializer=function(b,c,e,f,h){this.cmid=b,this.filter=c,this.filterall=e,this.globalsize=f,this.usesize=h,g.info("Initialize Grouptool group administration","grouptool"),a(".path-mod-grouptool").on("click","tr[data-id] a[data-rename]",this,this.renamegroup),g.debug("Init edit size button","grouptool"),d.get_strings([{key:"ajax_edit_size_help",component:"mod_grouptool"}]).done(function(b){var c={resizehelp:b[0]};g.debug("String successfully retrieved: "+b,"grouptool");var d={instance:i,strings:c,globalsize:i.globalsize};a(".path-mod-grouptool").on("click","tr[data-id] a[data-resize]",d,i.resizegroup)}).fail(function(a){g.error("Error while retrieving string: "+a,"grouptool")});var j=[{key:"confirm_delete_title",component:"mod_grouptool"},{key:"confirm_delete",component:"mod_grouptool"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}];d.get_strings(j).done(function(b){g.info("Strings successfully retrieved: "+b,"grouptool");var c={title:b[0],confirm:b[1],yes:b[2],no:b[3]};a(".path-mod-grouptool .mod_grouptool_sortlist").on("click","tr[data-id] a[data-delete]",{cmid:i.cmid,strings:c},i.deletegroup)}).fail(function(a){g.error("Error while retrieving strings: "+a,"grouptool")}),a(".path-mod-grouptool .mod_grouptool_sortlist").on("click","tr[data-id] a[data-toggle]",this,this.togglegroup)},i});