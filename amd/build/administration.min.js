define(["jquery","core/templates","core/ajax","core/str","core/url","core/notification","core/log"],function(a,b,c,d,e,f,g){var h=function(){this.cmid=0,this.filter=null,this.filterall=null,this.globalsize=3};h.prototype.renamegroup=function(d){g.info("Rename Group!","grouptool"),d.preventDefault(),d.stopPropagation();var e={},h=[];d.target=a(d.target).closest("[data-rename]");var i=d.target.closest("tr"),j=i.data("id"),k=d.target,l=k.prevAll("input[type=hidden]"),m=k.prevAll("span.text"),n="";k.fadeOut(600),l.fadeOut(600),m.fadeOut(600,function(){l.attr("type","text"),l.fadeIn(600),l.focus(),l.select()}),l.on("keydown",null,d.data,function(d){13!==d.which&&27!==d.which||(d.preventDefault(),d.stopPropagation()),13===d.which?(h=c.call([{methodname:"mod_grouptool_rename_group",args:{cmid:d.data.cmid,groupid:j,name:l.val()},fail:f.exception}]),n&&(n.fadeOut(600),n.remove()),h[0].then(function(c){c.error?(e={message:c.error},b.render("core/notification_error",e).then(function(b){n=a(b),n.hide(),i.find(".grpname div").prepend(n),n.fadeIn(600),window.setTimeout(function(){n.fadeOut(600,function(){n.remove()})},6e4)}).fail(f.exception)):(e={message:c.message},b.render("core/notification_success",e).then(function(b){n=a(b),n.hide(),i.find(".grpname div").prepend(n),n.fadeIn(600),m.html(l.val()),l.fadeOut(600,function(){l.attr("value",l.val()),l.attr("type","hidden"),m.fadeIn(600),k.fadeIn(600)}),l.off("keydown"),window.setTimeout(function(){n.fadeOut(600,function(){n.remove()})},5e3)}).fail(f.exception),g.info("AJAX Call to rename group "+j+" successfull\n"+status,"grouptool"))})):27===d.which&&(l.fadeOut(600,function(){m.hide(),l.attr("type","hidden"),l.val(m.html()),l.attr("value",m.html()),m.fadeIn(600),k.fadeIn(600)}),n&&n.fadeOut(600,function(){n.remove()}),l.unbind("key"))})},h.prototype.resizegroup=function(d){g.info("Resize Group!","grouptool"),d.preventDefault(),d.stopPropagation(),d.target=a(d.target).closest("[data-resize]");var e=d.target.closest("tr"),h=e.data("id"),i=d.data.instance.cmid,j=d.data.strings,k=d.data.globalsize,l=d.target,m=l.prevAll("input[type=hidden]"),n=l.prevAll("span.text"),o="",p="",q={},r=[];l.fadeOut(600),m.fadeOut(600),n.fadeOut(600,function(){m.attr("type","text"),m.fadeIn(600),m.focus(),m.select();var c={message:j.resizehelp};b.render("core/notification_info",c).then(function(b){p=a(b),p.hide(),e.find(".size div").prepend(p),p.fadeIn(600)}).fail(f.exception)}),m.on("keydown",null,null,function(d){13!==d.which&&27!==d.which||(d.preventDefault(),d.stopPropagation()),13===d.which?(r=c.call([{methodname:"mod_grouptool_resize_group",args:{cmid:parseInt(i),groupid:h,size:parseInt(m.val())},fail:f.exception}]),o&&(o.fadeOut(600),o.remove()),p&&(p.fadeOut(600),p.remove()),r[0].then(function(c){c.error?(q={message:c.error},b.render("core/notification_error",q).then(function(b){o=a(b),o.hide(),e.find(".size div").prepend(o),o.fadeIn(600),window.setTimeout(function(){o.fadeOut(600,function(){o.remove()})},6e4)}).fail(f.exception)):(q={message:c.message},b.render("core/notification_success",q).then(function(b){o=a(b),o.hide(),e.find(".size div").prepend(o),o.fadeIn(600);var c=m.val();""===c?n.html(k+"*"):n.html(c),m.fadeOut(600,function(){m.attr("value",m.val()),m.attr("type","hidden"),n.fadeIn(600),l.fadeIn(600),m.off("keydown")}),window.setTimeout(function(){o.fadeOut(600,function(){o.remove()})},5e3)}).fail(f.exception)),g.info("AJAX Call to resize group "+h+" successfull\n"+status,"grouptool")})):27===d.which&&(m.fadeOut(600,function(){n.hide(),m.attr("type","hidden"),m.attr("value",n.html()),m.val(n.html()),n.fadeIn(600),l.fadeIn(600)}),o&&o.fadeOut(600,function(){o.remove()}),p&&p.fadeOut(600,function(){o.remove()}),m.unbind("key"))})},h.prototype.togglegroup=function(h){h.preventDefault(),h.stopPropagation();var i=[],j={};h.target=a(h.target).closest("[data-toggle]");var k=h.target.closest("tr"),l=k.data("id");g.info("TOGGLE GROUP "+l,"grouptool");var m=k.data("status");1===m||m===!0?(g.info("DEACTIVATE GROUP "+l+"!","grouptool"),i=c.call([{methodname:"mod_grouptool_deactivate_group",args:{cmid:h.data.cmid,groupid:l},fail:f.exception}]),i[0].then(function(c){if(c.error){var i="AJAX Call to deactivate group "+l+" successfull but error occured:\n";g.info(i+c.error+"\n"+m,"grouptool")}else{if("active"===h.data.filter)k.find("td div").slideUp(600).promise().done(function(){if(k.remove(),!a("div.sortlist_container tr").length){var c=[{key:"nogroupsactive",component:"mod_grouptool"},{key:"nogroupschoose",component:"mod_grouptool"}];d.get_strings(c).done(function(c){var d=e.relativeUrl("/mod/grouptool/view.php",{id:h.data.cmid,tab:"group_administration",filter:h.data.filterall}),g='<a href="'+d+'">'+c[2]+"</a>",i={message:c[0]+g},j=a("div.sortlist_container");j.fadeOut(600,function(){b.render("core/notification_info",i).then(function(a){j.html(a),j.fadeIn(600)}).fail(f.exception)})}).fail(f.exception)}});else{j={status:!1,missing:!1,groupings:h.target.closest("tr").data("groupings"),id:l,checked:h.target.closest("tr").find("input[type=checkbox]").prop("checked"),name:h.target.closest("tr").data("name"),pageurl:e.relativeUrl("/mod/grouptool/view.php",{id:h.data.cmid,tab:"administration"}),order:h.target.closest("tr").data("order"),usesize:!!h.data.usesize,size:h.target.closest("tr").data("size")};var n=b.render("mod_grouptool/sortlist_entry",j);k.toggleClass("slidup"),k.find("td div").slideUp(600).promise().done(function(){n.then(function(b){var c=k.parents("table").find("tr[data-status=0], tr[data-status=false]").first(),d=k.parents("table").find("tr[data-status=1], tr[data-status=true]").last();c.length?(k.detach(),k.insertBefore(c)):d.length&&(k.detach(),k.insertAfter(d));var e=a(b);e.addClass("slidup"),e.find("td div").slideUp(0),k.replaceWith(e),e.find("[data-drag]").removeClass("js_invisible").css("cursor","pointer"),e.toggleClass("slidup"),e.find("td div").slideDown(600),k=e}).fail(f.exception)})}g.info("AJAX Call to deactivate group "+l+" successfull\n"+c.message+"\n"+m,"grouptool")}})):0===m||m===!1?(g.info("ACTIVATE GROUP "+l+"!","grouptool"),i=c.call([{methodname:"mod_grouptool_activate_group",args:{cmid:h.data.cmid,groupid:l},fail:f.exception}]),i[0].then(function(c){if(c.error){var i="AJAX Call to activate group "+l+" successfull but error occured:\n";g.info(i+c.error+"\n"+m,"grouptool")}else{if("inactive"===h.data.filter)k.find("td div").slideUp(600).promise().done(function(){if(k.remove(),!a("div.sortlist_container tr").length){var c=[{key:"nogroupsinactive",component:"mod_grouptool"},{key:"nogroupschoose",component:"mod_grouptool"}];d.get_strings(c).done(function(c){var d=e.relativeUrl("/mod/grouptool/view.php",{id:h.data.cmid,tab:"group_administration",filter:h.data.filterall}),g='<a href="'+d+'">'+c[2]+"</a>";j={message:c[0]+g};var i=a("div.sortlist_container");i.fadeOut(600,function(){b.render("core/notification_info",j).then(function(a){i.html(a),i.fadeIn(600)}).fail(f.exception)})}).fail(f.exception)}});else{j={status:!0,missing:!1,groupings:k.data("groupings"),id:l,checked:k.find("input[type=checkbox]").prop("checked"),name:k.data("name"),pageurl:e.relativeUrl("/mod/grouptool/view.php",{id:h.data.cmid,tab:"administration"}),order:k.data("order"),usesize:!!h.data.usesize,size:k.data("size")};var n=b.render("mod_grouptool/sortlist_entry",j);k.toggleClass("slidup"),h.target.closest("tr").find("td div").slideUp(600).promise().done(function(){n.then(function(b){var c=k.parents("table").find("tr[data-status=0], tr[data-status=false]").first(),d=k.parents("table").find("tr[data-status=1], tr[data-status=true]").last();d.length?(k.detach(),k.insertAfter(d)):c.length&&(k.detach(),k.insertBefore(c));var e=a(b);e.addClass("slidup"),e.find("td div").slideUp(0),k.replaceWith(e),e.find("[data-drag]").removeClass("js_invisible").css("cursor","pointer"),e.toggleClass("slidup"),e.find("td div").slideDown(600),k=e}).fail(f.exception)})}g.info("AJAX Call to activate group "+l+" successfull\n"+c.message,"grouptool")}})):g.error("Group with id "+l+" must have either status 1 or 0!","grouptool")},h.prototype.deletegroup=function(b){b.preventDefault(),b.stopPropagation(),b.target=a(b.target).closest("[data-delete]");var d=b.target.closest("tr"),e=d.data("id"),h=b.data.strings;f.confirm(h.title,h.confirm,h.yes,h.no,function(){if(!e)return void g.info("No Group ID!","grouptool");g.info("DELTE GROUP "+e+"!","grouptool");var a=c.call([{methodname:"mod_grouptool_delete_group",args:{cmid:b.data.cmid,groupid:e},fail:f.exception}]);a[0].then(function(a){a.error?f.exception(a.error):d.find("td div").slideUp(600).promise().done(function(){d.remove()}),g.info("AJAX Call to delete group "+e+" successfull\n"+status,"grouptool")})})};var i=new h;return i.initializer=function(b,c,e,f,h,j){this.cmid=b,this.filter=c,this.filterid=e,this.filterall=f,this.globalsize=h,this.usesize=j,g.info("Initalize Grouptool group administration","grouptool"),a(".path-mod-grouptool").on("click","tr[data-id] a[data-rename]",this,this.renamegroup),g.debug("Init edit size button","grouptool"),d.get_strings([{key:"ajax_edit_size_help",component:"mod_grouptool"}]).done(function(b){var c={resizehelp:b[0]};g.debug("String successfully retrieved: "+b,"grouptool");var d={instance:i,strings:c,globalsize:i.globalsize};a(".path-mod-grouptool").on("click","tr[data-id] a[data-resize]",d,i.resizegroup)}).fail(function(a){g.error("Error while retrieving string: "+a,"grouptool")});var k=[{key:"confirm_delete_title",component:"mod_grouptool"},{key:"confirm_delete",component:"mod_grouptool"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}];d.get_strings(k).done(function(b){g.info("Strings successfully retrieved: "+b,"grouptool");var c={title:b[0],confirm:b[1],yes:b[2],no:b[3]};a(".path-mod-grouptool .mod_grouptool_sortlist").on("click","tr[data-id] a[data-delete]",{cmid:i.cmid,strings:c},i.deletegroup)}).fail(function(a){g.error("Error while retrieving strings: "+a,"grouptool")}),a(".path-mod-grouptool .mod_grouptool_sortlist").on("click","tr[data-id] a[data-toggle]",this,this.togglegroup)},i});