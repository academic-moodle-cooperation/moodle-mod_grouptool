define(["jquery","core/config","core/templates","core/ajax","core/str","core/url","core/notification","core/log"],function(a,b,c,d,e,f,g,h){var i=function(){this.cmid=0,this.filter=null,this.filterall=null,this.globalsize=3};i.prototype.renamegroup=function(b){h.info("Rename Group!","grouptool"),b.preventDefault(),b.stopPropagation();var e={},f=[];b.target=a(b.target).closest("[data-rename]");var i=b.target.closest("tr"),j=i.data("id"),k=b.target,l=k.prevAll("input[type=hidden]"),m=k.prevAll("span.text"),n="";k.fadeOut(600),l.fadeOut(600),m.fadeOut(600,function(){l.attr("type","text"),l.fadeIn(600),l.focus(),l.select()}),l.on("keydown",null,b.data,function(b){13!==b.which&&27!==b.which||(b.preventDefault(),b.stopPropagation()),13===b.which?(f=d.call([{methodname:"mod_grouptool_rename_group",args:{cmid:b.data.cmid,groupid:j,name:l.val()},fail:g.exception}]),n&&(n.fadeOut(600),n.remove()),f[0].then(function(b){b.error?(e={message:b.error},c.render("core/notification_error",e).then(function(b){n=a(b),n.hide(),i.find(".grpname div").prepend(n),n.fadeIn(600),window.setTimeout(function(){n.fadeOut(600,function(){n.remove()})},6e4)}).fail(g.exception)):(e={message:b.message},c.render("core/notification_success",e).then(function(b){n=a(b),n.hide(),i.find(".grpname div").prepend(n),n.fadeIn(600),m.html(l.val()),l.fadeOut(600,function(){l.attr("value",l.val()),l.attr("type","hidden"),m.fadeIn(600),k.fadeIn(600)}),l.off("keydown"),window.setTimeout(function(){n.fadeOut(600,function(){n.remove()})},5e3)}).fail(g.exception),h.info("AJAX Call to rename group "+j+" successfull\n"+status,"grouptool"))})):27===b.which&&(l.fadeOut(600,function(){m.hide(),l.attr("type","hidden"),l.val(m.html()),l.attr("value",m.html()),m.fadeIn(600),k.fadeIn(600)}),n&&n.fadeOut(600,function(){n.remove()}),l.unbind("key"))})},i.prototype.resizegroup=function(b){h.info("Resize Group!","grouptool"),b.preventDefault(),b.stopPropagation(),b.target=a(b.target).closest("[data-resize]");var e=b.target.closest("tr"),f=e.data("id"),i=b.data.instance.cmid,j=b.data.strings,k=b.data.globalsize,l=b.target,m=l.prevAll("input[type=hidden]"),n=l.prevAll("span.text"),o="",p="",q={},r=[];l.fadeOut(600),m.fadeOut(600),n.fadeOut(600,function(){m.attr("type","text"),m.fadeIn(600),m.focus(),m.select();var b={message:j.resizehelp};c.render("core/notification_info",b).then(function(b){p=a(b),p.hide(),e.find(".size div").prepend(p),p.fadeIn(600)}).fail(g.exception)}),m.on("keydown",null,null,function(b){13!==b.which&&27!==b.which||(b.preventDefault(),b.stopPropagation()),13===b.which?(r=d.call([{methodname:"mod_grouptool_resize_group",args:{cmid:parseInt(i),groupid:f,size:parseInt(m.val())},fail:g.exception}]),o&&(o.fadeOut(600),o.remove()),p&&(p.fadeOut(600),p.remove()),r[0].then(function(b){b.error?(q={message:b.error},c.render("core/notification_error",q).then(function(b){o=a(b),o.hide(),e.find(".size div").prepend(o),o.fadeIn(600),window.setTimeout(function(){o.fadeOut(600,function(){o.remove()})},6e4)}).fail(g.exception)):(q={message:b.message},c.render("core/notification_success",q).then(function(b){o=a(b),o.hide(),e.find(".size div").prepend(o),o.fadeIn(600);var c=m.val();""===c?n.html(k+"*"):n.html(c),m.fadeOut(600,function(){m.attr("value",m.val()),m.attr("type","hidden"),n.fadeIn(600),l.fadeIn(600),m.off("keydown")}),window.setTimeout(function(){o.fadeOut(600,function(){o.remove()})},5e3)}).fail(g.exception)),h.info("AJAX Call to resize group "+f+" successfull\n"+status,"grouptool")})):27===b.which&&(m.fadeOut(600,function(){n.hide(),m.attr("type","hidden"),m.attr("value",n.html()),m.val(n.html()),n.fadeIn(600),l.fadeIn(600)}),o&&o.fadeOut(600,function(){o.remove()}),p&&p.fadeOut(600,function(){o.remove()}),m.unbind("key"))})},i.prototype.togglegroup=function(b){b.preventDefault(),b.stopPropagation();var i=[],j={};b.target=a(b.target).closest("[data-toggle]");var k=b.target.closest("tr"),l=k.data("id");h.info("TOGGLE GROUP "+l,"grouptool");var m=k.data("status");1===m||m===!0?(h.info("DEACTIVATE GROUP "+l+"!","grouptool"),i=d.call([{methodname:"mod_grouptool_deactivate_group",args:{cmid:b.data.cmid,groupid:l},fail:g.exception}]),i[0].then(function(d){if(d.error){var i="AJAX Call to deactivate group "+l+" successfull but error occured:\n";h.info(i+d.error+"\n"+m,"grouptool")}else{if("active"===b.data.filter)k.find("td div").slideUp(600).promise().done(function(){k.remove(),a("div.sortlist_container tr").length||e.get_strings([{key:"nogroupsactive",component:"mod_grouptool"},{key:"nogroupschoose",component:"mod_grouptool"}]).done(function(d){var e=f.relativeUrl("/mod/grouptool/view.php",{id:b.data.cmid,tab:"group_administration",filter:b.data.filterall}),h='<a href="'+e+'">'+d[2]+"</a>",i={message:d[0]+h},j=a("div.sortlist_container");j.fadeOut(600,function(){c.render("core/notification_info",i).then(function(a){j.html(a),j.fadeIn(600)}).fail(g.exception)})}).fail(g.exception)});else{j={status:!1,missing:!1,groupings:b.target.closest("tr").data("groupings"),id:l,checked:b.target.closest("tr").find("input[type=checkbox]").prop("checked"),name:b.target.closest("tr").data("name"),pageurl:f.relativeUrl("/mod/grouptool/view.php",{id:b.data.cmid,tab:"administration"}),order:b.target.closest("tr").data("order"),usesize:!!b.data.usesize,size:b.target.closest("tr").data("size")};var n=c.render("mod_grouptool/sortlist_entry",j);k.toggleClass("slidup"),k.find("td div").slideUp(600).promise().done(function(){n.then(function(b){var c=k.parents("table").find("tr[data-status=0], tr[data-status=false]").first(),d=k.parents("table").find("tr[data-status=1], tr[data-status=true]").last();c.length?(k.detach(),k.insertBefore(c)):d.length&&(k.detach(),k.insertAfter(d));var e=a(b);e.addClass("slidup"),e.find("td div").slideUp(0),k.replaceWith(e),e.find("[data-drag]").removeClass("js_invisible").css("cursor","pointer"),e.toggleClass("slidup"),e.find("td div").slideDown(600),k=e}).fail(g.exception)})}h.info("AJAX Call to deactivate group "+l+" successfull\n"+d.message+"\n"+m,"grouptool")}})):0===m||m===!1?(h.info("ACTIVATE GROUP "+l+"!","grouptool"),i=d.call([{methodname:"mod_grouptool_activate_group",args:{cmid:b.data.cmid,groupid:l},fail:g.exception}]),i[0].then(function(d){if(d.error){var i="AJAX Call to activate group "+l+" successfull but error occured:\n";h.info(i+d.error+"\n"+m,"grouptool")}else{if("inactive"===b.data.filter)k.find("td div").slideUp(600).promise().done(function(){k.remove(),a("div.sortlist_container tr").length||e.get_strings([{key:"nogroupsinactive",component:"mod_grouptool"},{key:"nogroupschoose",component:"mod_grouptool"}]).done(function(d){var e=f.relativeUrl("/mod/grouptool/view.php",{id:b.data.cmid,tab:"group_administration",filter:b.data.filterall}),h='<a href="'+e+'">'+d[2]+"</a>";j={message:d[0]+h};var i=a("div.sortlist_container");i.fadeOut(600,function(){c.render("core/notification_info",j).then(function(a){i.html(a),i.fadeIn(600)}).fail(g.exception)})}).fail(g.exception)});else{j={status:!0,missing:!1,groupings:k.data("groupings"),id:l,checked:k.find("input[type=checkbox]").prop("checked"),name:k.data("name"),pageurl:f.relativeUrl("/mod/grouptool/view.php",{id:b.data.cmid,tab:"administration"}),order:k.data("order"),usesize:!!b.data.usesize,size:k.data("size")};var n=c.render("mod_grouptool/sortlist_entry",j);k.toggleClass("slidup"),b.target.closest("tr").find("td div").slideUp(600).promise().done(function(){n.then(function(b){var c=k.parents("table").find("tr[data-status=0], tr[data-status=false]").first(),d=k.parents("table").find("tr[data-status=1], tr[data-status=true]").last();d.length?(k.detach(),k.insertAfter(d)):c.length&&(k.detach(),k.insertBefore(c));var e=a(b);e.addClass("slidup"),e.find("td div").slideUp(0),k.replaceWith(e),e.find("[data-drag]").removeClass("js_invisible").css("cursor","pointer"),e.toggleClass("slidup"),e.find("td div").slideDown(600),k=e}).fail(g.exception)})}h.info("AJAX Call to activate group "+l+" successfull\n"+d.message,"grouptool")}})):h.error("Group with id "+l+" must have either status 1 or 0!","grouptool")},i.prototype.deletegroup=function(b){b.preventDefault(),b.stopPropagation(),b.target=a(b.target).closest("[data-delete]");var c=b.target.closest("tr"),e=c.data("id"),f=b.data.strings;g.confirm(f.title,f.confirm,f.yes,f.no,function(){if(!e)return void h.info("No Group ID!","grouptool");h.info("DELTE GROUP "+e+"!","grouptool");var a=d.call([{methodname:"mod_grouptool_delete_group",args:{cmid:b.data.cmid,groupid:e},fail:g.exception}]);a[0].then(function(a){a.error?g.exception(a.error):c.find("td div").slideUp(600).promise().done(function(){c.remove()}),h.info("AJAX Call to delete group "+e+" successfull\n"+status,"grouptool")})})};var j=new i;return j.initializer=function(b,c,d,f,g,i){this.cmid=b,this.filter=c,this.filterid=d,this.filterall=f,this.globalsize=g,this.usesize=i,h.info("Initalize Grouptool group administration","grouptool"),a(".path-mod-grouptool").on("click","tr[data-id] a[data-rename]",this,this.renamegroup),h.debug("Init edit size button","grouptool"),e.get_strings([{key:"ajax_edit_size_help",component:"mod_grouptool"}]).done(function(b){var c={resizehelp:b[0]};h.debug("String successfully retrieved: "+b,"grouptool");var d={instance:j,strings:c,globalsize:j.globalsize};a(".path-mod-grouptool").on("click","tr[data-id] a[data-resize]",d,j.resizegroup)}).fail(function(a){h.error("Error while retrieving string: "+a,"grouptool")});var k=[{key:"confirm_delete_title",component:"mod_grouptool"},{key:"confirm_delete",component:"mod_grouptool"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}];e.get_strings(k).done(function(b){h.info("Strings successfully retrieved: "+b,"grouptool");var c={title:b[0],confirm:b[1],yes:b[2],no:b[3]};a(".path-mod-grouptool .mod_grouptool_sortlist").on("click","tr[data-id] a[data-delete]",{cmid:j.cmid,strings:c},j.deletegroup)}).fail(function(a){h.error("Error while retrieving strings: "+a,"grouptool")}),a(".path-mod-grouptool .mod_grouptool_sortlist").on("click","tr[data-id] a[data-toggle]",this,this.togglegroup)},j});